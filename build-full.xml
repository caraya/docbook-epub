<project name="eBook" default="docbook-single" basedir=".">
<description>
	Apache ant build file for Docbook based ebooks
</description>
<!-- Created by Carlos Araya as part of his eBook research -->

<!-- Required for the IF Task -->
<taskdef resource="net/sf/antcontrib/antcontrib.properties"/>
<!-- Change the value of src_file to the name of your ebook file without extension-->
<property name="src_file" value="docbook-howto"/>

<!-- 
	Change the properties below to the full path of the respective tools on your system. 
	
	This should work on Windows, Mac and Linux since Ant is crossplatform... I hope :-)
-->
<property name="saxon_bin" value="/usr/local/java/saxon.jar"/>
<property name="fop_bin" value="/usr/local/java/fop/build/fop.jar"/>
<property name="epubcheck_bin" value="/usr/local/java/epubcheck/epubcheck-3.0b4.jar"/>
<property name="kindlegen_bin" value="/usr/local/kindlegen/kindlegen"/>
<property name="xsltproc_bin" value="/usr/bin/xsltproc"/>
<property name="xmllint_bin" value="/usr/bin/xmllint"/>

<!-- set global properties for this build -->
<property name="dest"  location="ebook-content"/> 
<property name="css"  location="${dest}/css"/> 
<property name="js"  location="${dest}/js"/> 
<property name="images"  location="${dest}/images"/> 

<target name="init">
	<!-- 
		Create the destination directory and appropriate sub directories
		if they don't exist already
	-->
	<if>
		<available file="${dest}" type="dir" />
		<then>
			<echo message="Directory ${dest} exist... skiping" />
		</then>
		<else>
			<echo>Creating directory</echo>
			<mkdir dir="${dest}"/>
			<echo>Creating CSS directory</echo>
			<mkdir dir="${css}"/>
			<echo>Creating JS directory</echo>
			<mkdir dir="${js}"/>
			<echo>Creating image directory</echo>
			<mkdir dir="${images}"/>
		</else>
	</if>
	<!-- 
		Copy CSS, JS and any images into their directories 
	-->
	<copy todir="${css}">
		<fileset dir="." casesensitive="yes">
		  <include name="*.css"/>
		</fileset>
	</copy>
	<copy todir="${js}">
		<fileset dir="." casesensitive="yes">
		  <include name="*.js"/>
		</fileset>
	</copy>
	<copy todir="${images}">
		<fileset dir="." casesensitive="yes">
		  <include name="*.jpg"/>
		  <include name="*.gif"/>
		  <include name="*.png"/>
		</fileset>
	</copy>
</target>

<target name="docbook-single" depends="init">
	<echo>validate XML before converting to Docbook</echo>
	<antcall target="validate-xml"/>
	<echo>Generating HTML Single File using Saxon and XSLT2.0</echo>
	<echo>Saxon 9 or another XSLT2 processor must be used</echo>
	<java jar="${saxon_bin}" fork="true" failonerror="true" maxmemory="128m">
		<arg value="-s:${src_file}.xml"/>
		<arg value="-xsl:/usr/local/docbook/2.0/release/2.0.3/xslt/base/html/docbook.xsl"/>
		<arg value="-o:${src_file}-2.html"/>
	</java>
	<echo>Moving files to ${dest}</echo>
	<copy todir="${dest}">
		<fileset dir="." casesensitive="yes">
		  <include name="*.html"/>
		</fileset>
	</copy>
</target>

<target name="docbook-chunks">
	<echo>Generating HTML Chunks</echo>
	<exec executable="${xsltproc_bin}">
		<arg line="/usr/local/docbook/1.0/xslt/xhtml/chunk.xsl ${src_file}.xml"/>
  	</exec>
	<echo>Moving html files to ${dest}</echo>
	<copy todir="${dest}">
		<fileset dir="." casesensitive="yes">
		  <include name="*.html"/>
		</fileset>
	</copy>
</target>

<target name="docbook-fo">
	<echo>Creating FO file</echo>
	<exec executable="${xsltproc_bin}">
		<arg line="-o ${src_file}.fo /usr/local/docbook/1.0/xslt/fo/docbook.xsl ${src_file}.xml"/>
  	</exec>
</target>

<target name="pdf-fop" depends="docbook-fo">
	<echo>Using fop at ${fop_bin}</echo>
	<java jar="${fop_bin}" fork="true" failonerror="true" maxmemory="128m">
		<arg line="${src_file}.fo ${src_file}.pdf"/>
	</java>
</target>

<target name="epub2">
	<!-- Run the stylesheets first -->
	<echo>Creating HTML files for ebook</echo>
	<exec executable="${xsltproc_bin}">
		<arg line="/usr/local/docbook/1.0/xslt/epub/docbook.xsl ${src_file}.xml"/>
	</exec>
	<!-- Create mimetype file, required per epub spec -->
	<echo>Creating mimetype file</echo>
	<antcall target="make-mime"/>
	<!-- zips the fils for the epub -->
	<echo>Zipping files</echo>
	<antcall target="epub-zip"/>
	<!-- Runs epubcheck on the epub file -->
	<echo>Checking result with epubcheck</echo>
	<antcall target="epub-check"/>
	<!-- Creates a Kindlegen -->
	<echo>Creating Kindle .mobi version of book</echo>
	<antcall target="make-kindle"/>
</target>

<target name="epub3">
	<echo>Cleaning up prior epub content</echo>
	<antcall target="epub-clean"/>
	<echo>Creating HTML files for ebook</echo>
	<exec executable="${xsltproc_bin}">
		<arg line="--stringparam base.dir OEBPS/ /usr/local/docbook/1.0/xslt/epub3/chunk.xsl ${src_file}.xml"/>
	</exec>
	<!-- copy video resources into OEBPS/video -->
	<echo>Copying videos... this may take a while</echo>
	<antcall target="copy-videos"/>
	<!-- zips the fils for the epub -->
	<echo>Zipping files</echo>
	<antcall target="epub-zip"/>
	<!-- Runs epubcheck on the epub file -->
	<echo>Checking the resuls</echo>
	<antcall target="epub-check"/>
	<echo>Resulting file available: ${src_file}.epub</echo>
</target>


<!-- Utility targets called from elsewhere epub2 and epub3 targets-->
<target name="copy-videos">
	<copy file="video/do-lectures.mp4" tofile="OEBPS/video/do-lectures.mp4"/>
	<copy file="video/do-lectures.png" tofile="OEBPS/video/do-lectures.png"/>
</target>

<target name="make-mime">
	<!-- 
		Creates mimetype file as required by epub spec
		Used by epub2 2 target. EPub3 generates its own
	-->
	<echo file="mimetype">application/epub+zip</echo>
</target>

<target name="make-kindle">
	<!-- 
		Uses Kindlegen from Amazon to generate MOBI version of epub2
	-->
	<exec executable="${kindlegen_bin}">
		<arg line="${src_file}.epub"/>
	</exec>
</target>

<target name="epub-zip">
	<!-- 
		We use exec zip because I can't figure out if Ant's builtin zip 
		task conforms to what ePub expects 
	-->
	<!-- 
		Zip the mimetype first without compression as required
	-->
<exec executable="zip">
	<arg line="-X0 ${src_file}.epub mimetype"/>
</exec>
	<!-- 
		Then zip the other files into the zip/epub archive 
	-->
<exec executable="zip">
	<arg line="-r -X9 ${src_file}.epub META-INF OEBPS"/>
</exec>
</target>

<target name="epub-check">
	<!-- 
		Runs epubcheck on the resulting epub (either version)
	-->
	<java jar="${epubcheck_bin}" fork="true" failonerror="true" maxmemory="128m">
		<arg value="${src_file}.epub"/>
	</java>
</target>

<target name="all-clean">
	<!-- 
		Calls all the cleanup targets
	-->
	<antcall target="html-clean"/>
	<antcall target="fo-clean"/>
	<antcall target="epub-clean"/>
	<echo>Done deleting files!</echo>
</target>

<target name="html-clean">
	<!-- 
		Cleans up HTML leftovers 
	-->
	<delete verbose="true">
		<fileset dir="." includes="*.html"/>
	</delete>
	<delete dir="${dest}"/>
</target>

<target name="fo-clean">
	<!-- 
		Removes the .fo file leftover from creating the PDF version
	-->
	<delete file="${src_file}.fo"/> 
</target>

<target name="epub-clean">
	<!-- 
		Cleans up leftover epub stuff

		If OEBPS exists we assume the other files and directories do as well
		since Docbook would never create only OEBPS
	
		The if tasks uses ant-contrib. See http://rivendellweb.net/
		about what changes to make if you don't want to use 
		the task
	-->
	<if>
		<available file="OEBPS" type="dir" />
		<then>
			<echo message="Directory exist... deleting" />
			<delete verbose="true">
				<fileset dir="OEBPS" includes="*"/>
				<fileset dir="META-INF" includes="*"/>
			</delete>
			<delete verbose="true" file="mimetype"/>
			<delete verbose="true" dir="META-INF"/>
			<delete verbose="true" dir="OEBPS"/>
			<delete verbose="true" file="${src_file}.epub"/>
		</then>
		<else>
			<echo message="Directory DOES NOT exist... skipping" />
		</else>
	</if>
</target>

<target name="validate-xml">
	<!-- 
		We call xmllint to make sure that the XML validates
	-->
	<exec executable="${xmllint_bin}">
		<arg line="-noent -noout ${src_file}.xml"/>
	</exec>
</target>
</project>